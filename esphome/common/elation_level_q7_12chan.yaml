defaults:
  channel_r: 1
  channel_g: 2
  channel_b: 3
  channel_w: 4
  channel_shutter: 8
  channel_dimmer: 9
  light_id: dmx_light
  light_name: DMX Light

output:
  - platform: dmx512
    universe: dmx
    channel: ${channel_r}
    id: ${light_id}_red
  - platform: dmx512
    universe: dmx
    channel: ${channel_g}
    id: ${light_id}_green
  - platform: dmx512
    universe: dmx
    channel: ${channel_b}
    id: ${light_id}_blue
  - platform: dmx512
    universe: dmx
    channel: ${channel_w}
    id: ${light_id}_white
  - platform: dmx512
    universe: dmx
    channel: ${channel_dimmer}
    id: ${light_id}_dimmer

light:
  - platform: rgbw
    gamma_correct: 0
    restore_mode: RESTORE_DEFAULT_ON
    icon: mdi:spotlight
    default_transition_length: 0s
    name: ${light_name}
    id: ${light_id}
    red: ${light_id}_red
    green: ${light_id}_green
    blue: ${light_id}_blue
    white: ${light_id}_white
    on_turn_on:
      then:
        - lambda: |-
            std::string mode = id(${light_id}_mode).current_option();
            float speed = id(${light_id}_effect_speed).state / 100.0;
            int speed_offset = (int)(speed * 31);
            auto dimmer_call = id(${light_id}_dimmer_light).turn_on();
            int dimmer_value = id(${light_id}_dimmer_light).current_values.get_brightness() * 255;  // Get current brightness value (0-255)
            int value = 32;  // default solid

            if (mode == "Solid") {
              value = 32;
            } else if (mode == "Strobe") {
              value = 64 + speed_offset;
            } else if (mode == "Pulse") {
              value = 128 + speed_offset;
            } else if (mode == "Random Strobe") {
              value = 192 + speed_offset;
            }

            id(dmx).write_channel(${channel_shutter}, value);

            if (dimmer_value <= 5) {
              dimmer_value = 255;  // Set to full brightness if currently off
            }
            dimmer_call.set_brightness(dimmer_value / 255.0);  // Update the dimmer light state
            dimmer_call.perform();  // Perform the dimmer state change




  - platform: monochromatic
    restore_mode: RESTORE_DEFAULT_ON
    icon: mdi:blur
    default_transition_length: 0s
    disabled_by_default: true
    name: "${light_name} Dimmer"
    id: ${light_id}_dimmer_light
    output: ${light_id}_dimmer

select:
  - platform: template
    name: "${light_name} Mode"
    id: ${light_id}_mode
    optimistic: true
    restore_value: true
    options:
      - "Solid"
      - "Strobe"
      - "Pulse"
      - "Random Strobe"
    initial_option: "Solid"
    on_value:
      then:
        - lambda: |-
            float speed = id(${light_id}_effect_speed).state / 100.0;
            int speed_offset = (int)(speed * 31);
            int value = 32;  // default solid

            if (x == "Solid") {
              value = 32;
            } else if (x == "Strobe") {
              value = 64 + speed_offset;
            } else if (x == "Pulse") {
              value = 128 + speed_offset;
            } else if (x == "Random Strobe") {
              value = 192 + speed_offset;
            }

            id(dmx).write_channel(${channel_shutter}, value);

number:
  - platform: template
    name: "${light_name} Effect Speed"
    id: ${light_id}_effect_speed
    optimistic: true
    restore_value: true
    min_value: 0
    max_value: 100
    step: 1
    initial_value: 50
    unit_of_measurement: "%"
    icon: mdi:speedometer
    on_value:
      then:
        - lambda: |-
            std::string mode = id(${light_id}_mode).current_option();
            float speed = x / 100.0;
            int speed_offset = (int)(speed * 31);
            int value = 32;  // default solid

            if (mode == "Solid") {
              value = 32;
            } else if (mode == "Strobe") {
              value = 64 + speed_offset;
            } else if (mode == "Pulse") {
              value = 128 + speed_offset;
            } else if (mode == "Random Strobe") {
              value = 192 + speed_offset;
            }

            id(dmx).write_channel(${channel_shutter}, value);
